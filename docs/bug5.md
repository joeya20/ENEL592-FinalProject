## Bug 5: Memory Range Overlap Reversed Priority
As discussed in the CWE-1260 analysis, the priority between overlapping memory ranges is given to the lower "index" range in the RISC-V Privileged Specification. This idea is extended in the Flash controller -- the documentation states "Similar to RISCV pmp, if two region overlaps, the lower region index has higher priority". The memory regions in flash memory are configurable via two registers for each region (up to 7). In the first register, `MP_REGION_CFG_X`, the bit fields `EN_X` enables the region, `RD_EN_0` makes the region readable, `PROG_EN_0` makes the region programmable, `ERASE_EN_0` makes the region erasable, `SCRAMBLE_EN_0` makes the region scramable, `ECC_EN_0` makes the region ECC and Integrity checked, and `HE_EN_0` makes the region "high endurance enabled". The second register, `MP_REGION_X` holds two bit fields, `BASE_X` and `SIZE_0` that configure the base page number and number of pages of the memory region. Both these registers also have `REGWEN` lock bits. Fig. 1 illustrates the memory region checking functionality in OpenTitan. The first `always_comb` block checks for the matching region starting from the lowest region index, 0. The second outputs the appropriate access control for that region, stored in `region_attrs_i[i].cfg`. Reversing this ordering to decrementing from the highest memory region (e.g., `Regions-1`) would break the "agreement" held by the software and hardware and result in improperly managed region overlap, possibly leading to loss of confidentiality, integrity, and availability. This bug is shown in Fig. 2.

![](images/ot_flash_mp_good.jpg)
Figure 1: Secure OpenTitan Flash Memory Region Permission Check

![](images/ot_flash_mp_bad.jpg)
Figure 2: Buggy OpenTitan Flash Memory Region Permission Check